<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="An archive of articles and posts by Subhadip Jana."
    />
    <title>Article Archive - Subhadip Jana</title>

    <!-- Links to your existing files -->
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    
    <!-- Theme initialization (runs before body renders to prevent flash) -->
    <script>
      (function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
        }
      })();
    </script>
  </head>
  <body>
    <!-- Main Navigation Bar -->
    <nav>
      <div class="nav-container">
        <!-- Theme Toggle Button -->
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
          <i class="fa-solid fa-sun"></i>
          <i class="fa-solid fa-moon"></i>
        </button>
        
        <!-- Modern Icon-based Navigation -->
        <div class="modern-nav-wrapper">
          <div class="modern-nav-links">
            <a href="index.html" class="nav-item">
              <i class="fa-solid fa-house"></i>
              <span>Home</span>
            </a>
            <a href="index.html#about" class="nav-item">
              <i class="fa-solid fa-user"></i>
              <span>About</span>
            </a>
            <a href="index.html#skills" class="nav-item">
              <i class="fa-solid fa-code"></i>
              <span>Skills</span>
            </a>
            <a href="projects.html" class="nav-item">
              <i class="fa-solid fa-flask"></i>
              <span>Projects</span>
            </a>
            <a href="index.html#publications" class="nav-item">
              <i class="fa-solid fa-book"></i>
              <span>Publications</span>
            </a>
            <a href="index.html#experience" class="nav-item">
              <i class="fa-solid fa-briefcase"></i>
              <span>Experience</span>
            </a>
            <a href="index.html#scholarship" class="nav-item">
              <i class="fa-solid fa-award"></i>
              <span>Awards</span>
            </a>
            <a href="index.html#volunteering" class="nav-item">
              <i class="fa-solid fa-handshake-angle"></i>
              <span>Volunteering</span>
            </a>
            <a href="index.html#professional development" class="nav-item">
              <i class="fa-solid fa-graduation-cap"></i>
              <span>Development</span>
            </a>
            <a href="blog.html" class="nav-item active">
              <i class="fa-solid fa-pen-to-square"></i>
              <span>Blogs</span>
            </a>
            <a href="index.html#contact" class="nav-item nav-item-contact">
              <i class="fa-solid fa-envelope"></i>
              <span>Contact</span>
            </a>
          </div>
        </div>
        
        <i class="fa-solid fa-bars hamburg" onclick="hamburg()"></i>
      </div>
      
      <!-- Mobile Dropdown Menu -->
      <div class="dropdown">
        <div class="links">
          <a href="index.html">Home</a>
          <a href="index.html#about">About</a>
          <a href="index.html#skills">Skills</a>
          <a href="projects.html">Projects</a>
          <a href="index.html#publications">Publications</a>
          <a href="index.html#experience">Experience</a>
          <a href="index.html#scholarship">Scholarship & Awards</a>
          <a href="index.html#volunteering">Volunteering</a>
          <a href="index.html#professional development">Professional Development</a>
          <a href="blog.html">Blogs</a>
          <a href="index.html#contact">Get In Touch</a>
          <i class="fa-solid fa-xmark cancel" onclick="cancel()"></i>
        </div>
      </div>
    </nav>

    <!-- This is the main content area for the new page -->
    <main class="page-section">
      <div class="blog-archive-container">
        <div class="page-title-header">
          <a href="index.html#blogs" class="back-arrow-btn" aria-label="Back to Blogs" title="Back to Blogs">
            <i class="fa-solid fa-arrow-left"></i>
          </a>
          <h2 class="section-title">Article Archive</h2>
        </div>

        <div class="blog-controls" data-aos="fade-up">
          <div class="blog-search">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input
              type="text"
              id="blog-search-input"
              placeholder="Search articles by keyword..."
            />
          </div>
        </div>

        <!-- This is the two-column layout -->
        <div class="blog-layout-grid">
          <!-- Left Column: Filters -->
          <aside class="filter-sidebar" data-aos="fade-right">
            <h4>Filter by Category</h4>
            <ul class="filter-list" id="filter-list-container">
              <!-- Filter buttons will be added here by JavaScript -->
              <li class="loading-filters">Loading categories...</li>
            </ul>
          </aside>

          <!-- Right Column: Article Feed -->
          <section class="article-feed" id="full-article-grid">
            <!-- Article cards will be added here by JavaScript -->
            <p class="loading-message">
              <i class="fa-solid fa-spinner fa-spin"></i>
              Loading all articles...
            </p>
          </section>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer>
      <div class="footer-container">
        <div class="footer-socials">
          <a href="https://github.com/SubhadipJana1409" target="_blank" aria-label="GitHub" class="github-icon"><i class="fa-brands fa-github"></i></a>
          <a href="https://facebook.com/SubhadipJana1409" target="_blank" aria-label="Facebook" class="facebook-icon"><i class="fa-brands fa-facebook"></i></a>
          <a href="https://linkedin.com/in/subhadip-jana1409" target="_blank" aria-label="LinkedIn" class="linkedin-icon"><i class="fa-brands fa-linkedin"></i></a>
          <a href="https://orcid.org/0009-0003-7860-2853" target="_blank" aria-label="ORCID" class="orcid-icon"><i class="fa-brands fa-orcid"></i></a>
          <a href="https://x.com/Subhadip1409" target="_blank" aria-label="Twitter" class="x-icon"><i class="fa-brands fa-x-twitter"></i></a>
        </div>

        <div class="footer-nav">
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="index.html#about">About</a></li>
            <li><a href="index.html#skills">Skills</a></li>
            <li><a href="index.html#projects">Projects</a></li>
            <li><a href="index.html#publications">Publications</a></li>
            <li><a href="index.html#experience">Experience</a></li>
            <li><a href="index.html#scholarship">Scholarship &amp; Awards</a></li>
            <li><a href="index.html#volunteering">Volunteering</a></li>
            <li><a href="index.html#professional development">Professional Development</a></li>
            <li><a href="index.html#blogs">Blogs</a></li>
            <li><a href="index.html#contact">Contact</a></li>
          </ul>
        </div>

        <div class="footer-bottom">
          <p>Copyright Â© 2025 by Subhadip Jana | All Rights Reserved.</p>
        </div>
        <div class="footer-icon-top">
          <a href="#">
            <i class="fa-solid fa-angle-up"></i>
            <p>Back to Top</p>
          </a>
        </div>
      </div>
    </footer>

    <!-- JS Library Imports -->
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script>
      AOS.init({ once: true, duration: 600 });

      // Mobile Menu toggle
      window.hamburg = () => {
        document.querySelector(".dropdown").style.transform = "translateY(0)";
      };
      window.cancel = () => {
        document.querySelector(".dropdown").style.transform =
          "translateY(-110%)";
      };
      
      // Theme Toggle functionality
      document.addEventListener('DOMContentLoaded', function() {
        const themeToggle = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;
        
        if (themeToggle) {
          themeToggle.addEventListener('click', function() {
            const currentTheme = htmlElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            if (newTheme === 'dark') {
              htmlElement.setAttribute('data-theme', 'dark');
            } else {
              htmlElement.removeAttribute('data-theme');
            }
            localStorage.setItem('theme', newTheme);
          });
        }
      });
    </script>

    <!-- ========= SCRIPT FOR THIS PAGE ONLY ========= -->

    <!-- === ADD THIS ENTIRE SCRIPT BLOCK TO blog.html === -->
    <script type="module">
      // --- PART 1: IMPORTS & GLOBAL VARS ---
      import { createClient } from "https://cdn.jsdelivr.net/npm/@sanity/client/+esm";
      let allPosts = []; // Master list

      // --- PART 2: ELEMENT SELECTORS ---
      const articleGrid = document.getElementById("full-article-grid");
      const filterListContainer = document.getElementById(
        "filter-list-container"
      );
      const searchInput = document.getElementById("blog-search-input");

      // --- PART 3: HELPER FUNCTIONS ---

      // === In blog.html script ===
      // Optimizes a Sanity CDN image URL with width and auto-format params
      function optimizeSanityUrl(url, width) {
        if (!url || !url.includes('cdn.sanity.io')) return url;
        return `${url}?w=${width}&auto=format`;
      }

      async function fetchSanityPosts(client) {
        // The query now asks for 'tags' instead of 'categories'
        const query = `*[_type == "post"]{_id, title, "slug": slug.current, "imageUrl": mainImage.asset->url, tags, publishedAt, "excerpt": pt::text(body)}`;
        const posts = await client.fetch(query);
        // We will rename 'tags' to 'categories' in our code for consistency
        return posts.map((p) => ({
          ...p,
          categories: p.tags,
          source: "sanity",
        }));
      }

      // === REPLACE this function in blog.html ===

      // === REPLACE this function in your blog.html script ===

      // === REPLACE this function in your blog.html script ===

      async function fetchMediumPosts() {
        const apiUrl =
          "https://api.rss2json.com/v1/api.json?rss_url=" +
          encodeURIComponent("https://medium.com/feed/@subhadipjana1409");
        try {
          const res = await fetch(apiUrl);
          if (!res.ok) throw new Error(`HTTP fetch failed: ${res.status}`);

          const data = await res.json();
          if (data.status !== "ok") {
            console.warn("Medium API returned an error:", data.message);
            return [];
          }

          return (data.items || []).map((item, index) => {
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = item.description;
            const imageTag = tempDiv.querySelector("img");

            // --- THIS IS THE KEY UPGRADE ---
            // 1. Get the list of tags that Medium provides.
            const mediumTags = item.categories || [];

            // 2. Create a new, clean list of categories.
            //    We use a Set to prevent duplicates, add the individual tags,
            //    and then ensure a "Medium" tag is always present.
            const finalCategories = [...new Set([...mediumTags, "Medium"])];

            return {
              _id: `medium_${index}`,
              title: item.title,
              link: item.link,
              imageUrl: imageTag
                ? imageTag.src
                : "https://via.placeholder.com/400x250/FFEBCD/6D4300?text=No+Image",
              publishedAt: new Date(item.pubDate).toISOString(),
              excerpt: tempDiv.textContent.substring(0, 150) + "...",

              // 3. Assign the final, complete list of categories to the post.
              categories: finalCategories,

              source: "medium",
            };
          });
        } catch (e) {
          console.error("Fetching or parsing Medium posts failed:", e);
          return []; // Return empty array on any failure
        }
      }

      function createPostCardHTML(post) {
        /* This function is correct, no changes */
        const postLink =
          post.source === "medium" ? post.link : `post.html?slug=${post.slug}`;
        const imageUrl =
          optimizeSanityUrl(post.imageUrl, 760) || "https://via.placeholder.com/400x250?text=Article";
        const postDate = new Date(post.publishedAt).toLocaleDateString(
          "en-US",
          { day: "numeric", month: "short", year: "numeric" }
        );
        return `<div class="blog-card" data-aos="fade-up"><a href="${postLink}" class="blog-card-img" target="_blank" rel="noopener noreferrer"><img src="${imageUrl}" alt="${
          post.title || ""
        }"></a><div class="blog-card-content"><h3 class="blog-title" style="font-size: 1.1rem;"><a href="${postLink}" target="_blank">${
          post.title || "Untitled"
        }</a></h3><div class="blog-meta" style="font-size: 0.8rem;"><span><i class="fa-regular fa-calendar"></i> ${postDate}</span></div></div></div>`;
      }

      function renderPosts(postsToRender) {
        /* This function is correct, no changes */
        articleGrid.innerHTML = "";
        if (postsToRender.length === 0) {
          articleGrid.innerHTML =
            "<p>No articles found matching your criteria.</p>";
          return;
        }
        postsToRender.forEach((post) => {
          articleGrid.insertAdjacentHTML("beforeend", createPostCardHTML(post));
        });
        if (window.AOS) setTimeout(() => AOS.refresh(), 100);
      }

      // Function to populate the category filters
      // === REPLACE your old populateFilters function with this new version ===
      // === In blog.html script ===
      function populateFilters() {
        if (!filterListContainer || allPosts.length === 0) return;

        const categories = new Set();
        allPosts.forEach((post) => {
          // This will now correctly read the mapped 'tags' or 'categories'
          if (Array.isArray(post.categories)) {
            post.categories.forEach((cat) => cat && categories.add(cat));
          }
        });

        let filterHTML =
          '<li><button class="filter-btn active" data-filter="all">All Articles</button></li>';
        categories.forEach((cat) => {
          filterHTML += `<li><button class="filter-btn" data-filter="${cat.toLowerCase()}">${cat}</button></li>`;
        });
        filterListContainer.innerHTML = filterHTML;
      }
      // --- PART 4: MAIN EXECUTION FLOW FOR THIS PAGE ---
      // === REPLACE the entire DOMContentLoaded block at the end of blog.html script ===

      document.addEventListener("DOMContentLoaded", async () => {
        const sanityClient = createClient({
          projectId: "18tiebeg",
          dataset: "production",
          useCdn: true,
          apiVersion: "2024-06-19",
        });

        if (!articleGrid) return; // Exit if we're not on the blog archive page

        try {
          // Fetch from both sources in parallel
          const [sanityPosts, mediumPosts] = await Promise.all([
            fetchSanityPosts(sanityClient),
            fetchMediumPosts(),
          ]);

          // =============================================== //
          // === SAFER COMBINING LOGIC ===
          // We ensure that even if one fetch returns nothing (or an error),
          // the other will still be processed.
          // =============================================== //
          const combinedPosts = [
            ...(sanityPosts || []),
            ...(mediumPosts || []),
          ];

          // Sort all the combined posts by date
          allPosts = combinedPosts.sort(
            (a, b) => new Date(b.publishedAt) - new Date(a.publishedAt)
          );

          // Now render and set up interactivity with the complete list
          renderPosts(allPosts);
          populateFilters();
          // Setup search and filter click handlers
          setupInteractivity();
        } catch (error) {
          console.error("Main blog fetch process failed:", error);
          articleGrid.innerHTML =
            '<p style="color:red;">Error loading articles.</p>';
        }
      });

      // A new helper function to group our event listeners
      function setupInteractivity() {
        // Search functionality
        searchInput.addEventListener("input", (e) => {
          const term = e.target.value.toLowerCase();
          const filtered = allPosts.filter((p) =>
            p.title.toLowerCase().includes(term)
          );
          renderPosts(filtered);
        });

        // Filter button functionality
        filterListContainer.addEventListener("click", (e) => {
          if (e.target.tagName === "BUTTON") {
            filterListContainer
              .querySelectorAll(".filter-btn")
              .forEach((btn) => btn.classList.remove("active"));
            e.target.classList.add("active");
            const filter = e.target.dataset.filter;
            const filtered =
              filter === "all"
                ? allPosts
                : allPosts.filter((p) =>
                    (p.categories || [])
                      .map((c) => c.toLowerCase())
                      .includes(filter)
                  );
            renderPosts(filtered);
          }
        });
      }
    </script>
  </body>
</html>
