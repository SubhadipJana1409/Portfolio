<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="A detailed archive of research projects by Subhadip Jana."
    />
    <title>Research Projects - Subhadip Jana</title>

    <!-- Links to your existing files -->
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    
    <!-- Theme initialization (runs before body renders to prevent flash) -->
    <script>
      (function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
        }
      })();
    </script>
  </head>
  <body>
    <!-- Main Navigation Bar -->
    <nav>
      <div class="nav-container">
        <!-- Theme Toggle Button -->
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
          <i class="fa-solid fa-sun"></i>
          <i class="fa-solid fa-moon"></i>
        </button>
        
        <!-- Modern Icon-based Navigation -->
        <div class="modern-nav-wrapper">
          <div class="modern-nav-links">
            <a href="index.html" class="nav-item">
              <i class="fa-solid fa-house"></i>
              <span>Home</span>
            </a>
            <a href="index.html#about" class="nav-item">
              <i class="fa-solid fa-user"></i>
              <span>About</span>
            </a>
            <a href="index.html#skills" class="nav-item">
              <i class="fa-solid fa-code"></i>
              <span>Skills</span>
            </a>
            <a href="projects.html" class="nav-item active">
              <i class="fa-solid fa-flask"></i>
              <span>Projects</span>
            </a>
            <a href="index.html#publications" class="nav-item">
              <i class="fa-solid fa-book"></i>
              <span>Publications</span>
            </a>
            <a href="index.html#experience" class="nav-item">
              <i class="fa-solid fa-briefcase"></i>
              <span>Experience</span>
            </a>
            <a href="index.html#scholarship" class="nav-item">
              <i class="fa-solid fa-award"></i>
              <span>Awards</span>
            </a>
            <a href="index.html#volunteering" class="nav-item">
              <i class="fa-solid fa-handshake-angle"></i>
              <span>Volunteering</span>
            </a>
            <a href="index.html#professional development" class="nav-item">
              <i class="fa-solid fa-graduation-cap"></i>
              <span>Development</span>
            </a>
            <a href="blog.html" class="nav-item">
              <i class="fa-solid fa-pen-to-square"></i>
              <span>Blogs</span>
            </a>
            <a href="index.html#contact" class="nav-item nav-item-contact">
              <i class="fa-solid fa-envelope"></i>
              <span>Contact</span>
            </a>
          </div>
        </div>
        
        <i class="fa-solid fa-bars hamburg" onclick="hamburg()"></i>
      </div>
      
      <!-- Mobile Dropdown Menu -->
      <div class="dropdown">
        <div class="links">
          <a href="index.html">Home</a>
          <a href="index.html#about">About</a>
          <a href="index.html#skills">Skills</a>
          <a href="projects.html">Projects</a>
          <a href="index.html#publications">Publications</a>
          <a href="index.html#experience">Experience</a>
          <a href="index.html#scholarship">Scholarship &amp; Awards</a>
          <a href="index.html#volunteering">Volunteering</a>
          <a href="index.html#professional development">Professional Development</a>
          <a href="blog.html">Blogs</a>
          <a href="index.html#contact">Get In Touch</a>
          <i class="fa-solid fa-xmark cancel" onclick="cancel()"></i>
        </div>
      </div>
    </nav>

    <!-- Projects Section - Content loaded dynamically from Sanity -->
    <section id="projects" class="page-section">
      <div class="projects-container">
        <div class="page-title-header">
          <a href="index.html#projects" class="back-arrow-btn" aria-label="Back to Projects" title="Back to Projects">
            <i class="fa-solid fa-arrow-left"></i>
          </a>
          <h2 class="section-title">Key Research Projects</h2>
        </div>

        <div class="project-grid" id="project-grid">
          <!-- Project cards rendered dynamically from Sanity -->
          <p class="loading-message" id="projects-loading">
            <i class="fa-solid fa-spinner fa-spin"></i>
            Loading projects...
          </p>
        </div>
      </div>
    </section>

    <!-- Single Reusable Modal (populated dynamically) -->
    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal" id="project-modal">
      <div class="modal-header">
        <h3 id="modal-title"></h3>
        <button class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <img id="modal-image" src="" alt="" class="modal-img" />
        <div id="modal-tags" class="card-tags" style="margin-bottom: 20px;"></div>
        <div id="modal-content"></div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <div class="footer-container">
        <div class="footer-socials">
          <a href="https://github.com/SubhadipJana1409" target="_blank" aria-label="GitHub" class="github-icon"><i class="fa-brands fa-github"></i></a>
          <a href="https://facebook.com/SubhadipJana1409" target="_blank" aria-label="Facebook" class="facebook-icon"><i class="fa-brands fa-facebook"></i></a>
          <a href="https://linkedin.com/in/subhadip-jana1409" target="_blank" aria-label="LinkedIn" class="linkedin-icon"><i class="fa-brands fa-linkedin"></i></a>
          <a href="https://orcid.org/0009-0003-7860-2853" target="_blank" aria-label="ORCID" class="orcid-icon"><i class="fa-brands fa-orcid"></i></a>
          <a href="https://x.com/Subhadip1409" target="_blank" aria-label="Twitter" class="x-icon"><i class="fa-brands fa-x-twitter"></i></a>
        </div>

        <div class="footer-nav">
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="index.html#about">About</a></li>
            <li><a href="index.html#skills">Skills</a></li>
            <li><a href="index.html#projects">Projects</a></li>
            <li><a href="index.html#publications">Publications</a></li>
            <li><a href="index.html#experience">Experience</a></li>
            <li><a href="index.html#scholarship">Scholarship &amp; Awards</a></li>
            <li><a href="index.html#volunteering">Volunteering</a></li>
            <li><a href="index.html#professional development">Professional Development</a></li>
            <li><a href="index.html#blogs">Blogs</a></li>
            <li><a href="index.html#contact">Contact</a></li>
          </ul>
        </div>

        <div class="footer-bottom">
          <p>Copyright &copy; 2025 by Subhadip Jana | All Rights Reserved.</p>
        </div>
        <div class="footer-icon-top">
          <a href="#">
            <i class="fa-solid fa-angle-up"></i>
            <p>Back to Top</p>
          </a>
        </div>
      </div>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@sanity/client/+esm";

      // ============================================================
      // Utility: Convert Sanity Block Content → HTML
      // Supports: headings, paragraphs, bold, italic, underline, code,
      //           ordered lists, unordered lists, and nested lists
      // ============================================================
      function blocksToHtml(blocks) {
        if (!blocks || !Array.isArray(blocks)) return "<p>No detailed description available.</p>";

        let html = "";
        let currentListType = null; // "bullet" or "number"
        let currentListLevel = 0;

        function closeOpenLists() {
          while (currentListLevel > 0) {
            html += currentListType === "number" ? "</ol>" : "</ul>";
            currentListLevel--;
          }
          currentListType = null;
        }

        blocks.forEach((block, index) => {
          if (block._type !== "block") {
            closeOpenLists();
            return;
          }

          const style = block.style || "normal";
          const listItem = block.listItem; // "bullet" or "number"
          const level = block.level || 1;

          // Render inline children with marks
          const childrenHtml = (block.children || []).map(child => {
            let text = child.text || "";
            // Escape HTML special chars
            text = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            if (child.marks && child.marks.length > 0) {
              child.marks.forEach(mark => {
                if (mark === "strong") text = `<strong>${text}</strong>`;
                else if (mark === "em") text = `<em>${text}</em>`;
                else if (mark === "underline") text = `<u>${text}</u>`;
                else if (mark === "code") text = `<code>${text}</code>`;
              });
            }
            return text;
          }).join("");

          // Handle list items
          if (listItem) {
            const tag = listItem === "number" ? "ol" : "ul";

            if (!currentListType) {
              // Starting a new list
              html += `<${tag}>`;
              currentListType = listItem;
              currentListLevel = level;
            } else if (level > currentListLevel) {
              // Nesting deeper
              html += `<${tag}>`;
              currentListLevel = level;
            } else if (level < currentListLevel) {
              // Coming back up
              while (currentListLevel > level) {
                html += currentListType === "number" ? "</ol>" : "</ul>";
                currentListLevel--;
              }
            } else if (listItem !== currentListType && level === 1) {
              // Switching list type at the same level
              closeOpenLists();
              html += `<${tag}>`;
              currentListType = listItem;
              currentListLevel = 1;
            }

            html += `<li>${childrenHtml}</li>`;
            return;
          }

          // Not a list item — close any open lists
          closeOpenLists();

          // Handle block styles
          switch (style) {
            case "h1": html += `<h1>${childrenHtml}</h1>`; break;
            case "h2": html += `<h2>${childrenHtml}</h2>`; break;
            case "h3": html += `<h3>${childrenHtml}</h3>`; break;
            case "h4": html += `<h4>${childrenHtml}</h4>`; break;
            case "blockquote": html += `<blockquote>${childrenHtml}</blockquote>`; break;
            default: html += `<p>${childrenHtml}</p>`; break;
          }
        });

        // Close any remaining open lists
        closeOpenLists();

        return html;
      }

      // ============================================================
      // Fetch ALL projects from Sanity
      // ============================================================
      // Optimizes a Sanity CDN image URL with width and auto-format params
      function optimizeSanityUrl(url, width) {
        if (!url || !url.includes('cdn.sanity.io')) return url;
        return `${url}?w=${width}&auto=format`;
      }

      async function fetchAllProjects(client) {
        try {
          const query = `*[_type == "project"] | order(order desc){
            _id, title, fullTitle, description, detailedDescription,
            "imageUrl": image.asset->url, tags
          }`;
          return await client.fetch(query);
        } catch (error) {
          console.error("Projects fetch failed:", error);
          return [];
        }
      }

      // ============================================================
      // Render project cards into the grid
      // ============================================================
      function renderProjectCards(projects) {
        const grid = document.getElementById("project-grid");
        const loading = document.getElementById("projects-loading");
        if (loading) loading.remove();

        if (!projects || projects.length === 0) {
          grid.innerHTML = `<p class="loading-message">No projects found. Add projects in Sanity Studio.</p>`;
          return;
        }

        projects.forEach((project, index) => {
          const imageUrl = optimizeSanityUrl(project.imageUrl, 600) || "assets/images/project-placeholder.png";
          const tagsHtml = (project.tags || []).map(tag => `<span>${tag}</span>`).join("");
          const shortDesc = project.description || "Click to view details.";

          const cardHtml = `
            <div class="project-card" data-aos="fade-up" data-aos-delay="${index * 100}" data-project-id="${project._id}">
              <img src="${imageUrl}" alt="${project.title}" loading="lazy" />
              <div class="card-content">
                <h4>${project.title}</h4>
                <p>${shortDesc}</p>
                <div class="card-tags">${tagsHtml}</div>
                <button class="details-btn" data-project-id="${project._id}">View Details</button>
              </div>
            </div>
          `;
          grid.insertAdjacentHTML("beforeend", cardHtml);
        });

        // Refresh AOS for newly rendered elements
        if (typeof AOS !== "undefined") AOS.refresh();
      }

      // ============================================================
      // Modal logic — single reusable modal, populated on click
      // ============================================================
      function setupModals(projects) {
        const overlay = document.getElementById("modal-overlay");
        const modal = document.getElementById("project-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalImage = document.getElementById("modal-image");
        const modalTags = document.getElementById("modal-tags");
        const modalContent = document.getElementById("modal-content");
        const closeBtn = modal.querySelector(".close-btn");

        function openModal(project) {
          // Use fullTitle for modal header, fallback to title
          modalTitle.textContent = project.fullTitle || project.title;
          modalImage.src = optimizeSanityUrl(project.imageUrl, 1200) || "assets/images/project-placeholder.png";
          modalImage.alt = project.title;
          modalTags.innerHTML = (project.tags || []).map(tag => `<span>${tag}</span>`).join("");
          modalContent.innerHTML = blocksToHtml(project.detailedDescription);
          modal.classList.add("active");
          overlay.classList.add("active");
          document.body.style.overflow = "hidden";
        }

        function closeModal() {
          modal.classList.remove("active");
          overlay.classList.remove("active");
          document.body.style.overflow = "";
        }

        // Attach click handlers to all "View Details" buttons
        document.querySelectorAll(".details-btn[data-project-id]").forEach(btn => {
          btn.addEventListener("click", () => {
            const project = projects.find(p => p._id === btn.dataset.projectId);
            if (project) openModal(project);
          });
        });

        overlay.addEventListener("click", closeModal);
        closeBtn.addEventListener("click", closeModal);
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });
      }

      // ============================================================
      // Initialization
      // ============================================================
      AOS.init({ once: true, duration: 800 });

      // Mobile Menu toggle
      window.hamburg = () => {
        document.querySelector(".dropdown").style.transform = "translateY(0)";
      };
      window.cancel = () => {
        document.querySelector(".dropdown").style.transform = "translateY(-110%)";
      };

      document.addEventListener("DOMContentLoaded", async () => {
        // Theme toggle
        const themeToggle = document.getElementById("theme-toggle");
        const htmlElement = document.documentElement;
        if (themeToggle) {
          themeToggle.addEventListener("click", () => {
            const currentTheme = htmlElement.getAttribute("data-theme");
            const newTheme = currentTheme === "dark" ? "light" : "dark";
            if (newTheme === "dark") {
              htmlElement.setAttribute("data-theme", "dark");
            } else {
              htmlElement.removeAttribute("data-theme");
            }
            localStorage.setItem("theme", newTheme);
          });
        }

        // Fetch and render projects from Sanity
        const sanityClient = createClient({
          projectId: "18tiebeg",
          dataset: "production",
          useCdn: true,
          apiVersion: "2024-06-19",
        });

        const projects = await fetchAllProjects(sanityClient);
        renderProjectCards(projects);
        setupModals(projects);
      });
    </script>
  </body>
</html>
